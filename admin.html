<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Administrador</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="style.css">

  <style>
    body {
  margin: 0;
  font-family: Arial, sans-serif;
  overflow-x: hidden;
}

    /* ===== HEADER ===== */
    .topbar {
      height: 60px;
      background: #020617;
      display: flex;
      align-items: center;
      padding: 0 20px;
      border-bottom: 1px solid #1e293b;
    }

    .menu-btn {
      font-size: 22px;
      cursor: pointer;
      background: none;
      border: none;
      color: #f8fafc;
    }

    .title {
      margin-left: 15px;
      font-weight: 600;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      position: fixed;
      top: 0;
      left: -260px;
      width: 260px;
      height: 100%;
      background: #020617;
      border-right: 1px solid #1e293b;
      transition: left 0.3s ease;
      padding-top: 60px;
      z-index: 1000;
    }

    .sidebar.active {
      left: 0;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar li {
      padding: 15px 20px;
      cursor: pointer;
      border-bottom: 1px solid #1e293b;
      transition: background 0.2s;
    }

    .sidebar li:hover {
      background: #1e293b;
    }

    .sidebar li span {
      margin-right: 10px;
    }

    /* ===== CONTENT ===== */
    .content {
      padding: 30px;
      transition: margin-left 0.3s ease;
    }

    .content.shift {
      margin-left: 260px;
    }
  </style>
</head>

<body>

  <div class="topbar">
    <button class="menu-btn" id="menuBtn">‚ò∞</button>
    <div class="title">Panel Administrador</div>
  </div>

  <div class="sidebar" id="sidebar">
    <ul>
      <li data-section="dashboard"><span>üìä</span>Dashboard</li>
      <li data-section="alta"><span>‚ûï</span>Alta de closers</li>
      <li data-section="baja"><span>‚ûñ</span>Baja de closers</li>
      <li data-section="closers"><span>üë§</span>Closers</li>
      <li data-section="ventas"><span>üí∞</span>Ventas</li>
      <li data-section="pagos"><span>üßæ</span>Pago mensual closers</li>
      <li data-section="historico"><span>üìÅ</span>Historico total</li>
      <li data-section="idioma"><span>üåç</span>Idioma</li>
      <li id="logoutBtn"><span>üö™</span>Logout</li>
    </ul>
  </div>

  <div class="content" id="contentArea">

  <!-- CONTENEDOR DIN√ÅMICO -->
  <div id="adminSection"></div>

</div>

<script src="auth.js"></script>

<script>
  const menuBtn = document.getElementById("menuBtn");
  const sidebar = document.getElementById("sidebar");
  const content = document.getElementById("contentArea");
  
  const adminSection = document.getElementById("adminSection");

async function loadSection(section) {

  if (section === "dashboard") {

    const res = await fetch("dashboard.html");
    const html = await res.text();
    adminSection.innerHTML = html;

    // Eliminar app.js anterior si existe
    const oldScript = document.querySelector("script[data-appjs]");
    if (oldScript) oldScript.remove();

    // Crear script nuevo
    const script = document.createElement("script");
    script.src = "app.js";
    script.setAttribute("data-appjs", "true");

    script.onload = function () {
      if (typeof initPricingApp === "function") {
        initPricingApp();
      }
    };

    document.body.appendChild(script);

  } else if (section === "alta") {

  adminSection.innerHTML = `
    <div class="alta-container">

      <button id="btnNuevoCloser" class="btn-nuevo-closer">
        ‚ûï Dar de alta nuevo closer
      </button>
      
      <button id="btnCrearDemoCloser" class="btn-nuevo-closer" style="margin-top:12px; background:#111;">
  üß™ Crear usuario demo
</button>

<div id="resultadoDemo" style="display:none;margin-top:15px;"></div>

<div id="demoCloserPanel" style="display:none;margin-top:25px;">
  <div class="card-credenciales">
    <h3>Simulaci√≥n de trabajo del closer</h3>
    <ol style="margin-top:10px;line-height:1.6;">
      <li>1Ô∏è‚É£ Inicia sesi√≥n con su usuario.</li>
      <li>2Ô∏è‚É£ Accede al motor de pricing.</li>
      <li>3Ô∏è‚É£ Calcula precio al restaurante.</li>
      <li>4Ô∏è‚É£ Genera enlace de pago.</li>
      <li>5Ô∏è‚É£ Cuando el cliente paga, la venta se registra autom√°ticamente.</li>
      <li>6Ô∏è‚É£ La comisi√≥n se acumula para el cierre mensual.</li>
    </ol>
    <p class="aviso">
      ‚ö† Esta es una simulaci√≥n visual. No crea datos reales.
    </p>
  </div>
</div>

      <div id="formAltaCloser" class="form-alta-closer" style="display:none;">
        
        <label>Nombre completo
          <input type="text" id="nuevoNombre" placeholder="Ej. Ismael Guerra">
        </label>

        <label>Municipio
          <input type="text" id="nuevoMunicipio" placeholder="Ej. Madrid">
        </label>

        <label>Tel√©fono
          <input type="text" id="nuevoTelefono" placeholder="Ej. +34 600 000 000">
        </label>

        <button id="btnCrearCloser" class="btn-crear-closer">
          Crear closer
        </button>

        <div id="resultadoAlta" class="resultado-alta" style="display:none;"></div>

      </div>

    </div>
  `;

  setTimeout(initAltaCloser, 0);

} else if (section === "baja") {

  adminSection.innerHTML = `
    <div style="max-width:1000px;margin:30px auto;">
      <h2 style="margin-bottom:25px;">Closers activos</h2>
      <div id="listaBajaClosers"></div>
    </div>
  `;

  setTimeout(initBajaClosers, 0);

} else if (section === "closers") {

  adminSection.innerHTML = `
    <div style="max-width:1000px;margin:30px auto;">
      <h2 style="margin-bottom:25px;">Gesti√≥n de Closers</h2>
      <div id="listaClosers"></div>
    </div>
  `;

  setTimeout(initClosersSection, 0);

} else {

  adminSection.innerHTML = `
    <h2>${section}</h2>
    <p>Secci√≥n en construcci√≥n.</p>
  `;

}
}

  function toggleMenu() {
    sidebar.classList.toggle("active");
    content.classList.toggle("shift");
  }

  function closeMenu() {
    sidebar.classList.remove("active");
    content.classList.remove("shift");
  }

  // Bot√≥n hamburguesa abre y cierra
  menuBtn.onclick = (e) => {
    e.stopPropagation();
    toggleMenu();
  };

  // Cerrar si haces click fuera del men√∫
  document.addEventListener("click", (e) => {
    if (
      sidebar.classList.contains("active") &&
      !sidebar.contains(e.target) &&
      e.target !== menuBtn
    ) {
      closeMenu();
    }
  });

  // Cerrar al hacer click en una opci√≥n
  document.querySelectorAll(".sidebar li").forEach(item => {
  item.addEventListener("click", () => {

    if (item.id === "logoutBtn") return;

    const section = item.dataset.section;
    if (section) {
      loadSection(section);
    }

    closeMenu();
  });
});

  // Logout
  document.getElementById("logoutBtn").onclick = () => {
    localStorage.clear();
    window.location.href = "login.html";
  };
  
  // Cargar Dashboard por defecto al entrar
loadSection("dashboard");

function initAltaCloser() {

  const btnNuevo = document.getElementById("btnNuevoCloser");
  const form = document.getElementById("formAltaCloser");
  const btnCrear = document.getElementById("btnCrearCloser");
  const resultado = document.getElementById("resultadoAlta");
  const resultadoDemo = document.getElementById("resultadoDemo");

  const btnCrearDemo = document.getElementById("btnCrearDemoCloser");

  // Mostrar formulario alta real
  btnNuevo.onclick = () => {
    form.style.display = "block";
  };

  // Crear closer REAL
  btnCrear.onclick = async () => {

    const full_name = document.getElementById("nuevoNombre").value.trim();
    const city = document.getElementById("nuevoMunicipio").value.trim();
    const phone = document.getElementById("nuevoTelefono").value.trim();

    if (!full_name || !city) {
      resultado.style.display = "block";
      resultado.innerHTML = `<p style="color:red;">Nombre y municipio son obligatorios</p>`;
      return;
    }

    btnCrear.disabled = true;
    btnCrear.textContent = "Creando...";

    try {

      const res = await fetch(
        "https://stripe-backend-h1z1.vercel.app/api/create-closer",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ full_name, city, phone })
        }
      );

      const data = await res.json();

      if (!res.ok) {
        resultado.style.display = "block";
        resultado.innerHTML = `<p style="color:red;">${data.error}</p>`;
        btnCrear.disabled = false;
        btnCrear.textContent = "Crear closer";
        return;
      }

      resultado.style.display = "block";
      resultado.innerHTML = `
        <div class="card-credenciales">
          <h3>Closer creado correctamente</h3>
          <p><strong>Usuario:</strong> ${data.username}</p>
          <p><strong>Contrase√±a:</strong> ${data.password}</p>
          <p class="aviso">‚ö† Copia estas credenciales ahora. No volver√°n a mostrarse.</p>
        </div>
      `;

      setTimeout(() => {
        resultado.style.display = "none";
      }, 3600000);

    } catch {
      resultado.style.display = "block";
      resultado.innerHTML = `<p style="color:red;">Error servidor</p>`;
    }

    btnCrear.disabled = false;
    btnCrear.textContent = "Crear closer";
  };

  // Crear usuario DEMO
btnCrearDemo.onclick = async () => {

  btnCrearDemo.disabled = true;
  btnCrearDemo.textContent = "Creando demo...";

  try {

    const res = await fetch(
      "https://stripe-backend-h1z1.vercel.app/api/create-demo-closer",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
      }
    );

    const data = await res.json();

    if (!res.ok) {
      resultadoDemo.style.display = "block";
      resultadoDemo.innerHTML = `<p style="color:red;">${data.error || "Error creando demo"}</p>`;
      return;
    }

    resultadoDemo.style.display = "block";
    resultadoDemo.innerHTML = `
      <div class="card-credenciales">
        <h3>Usuario demo creado</h3>
        <p><strong>Usuario:</strong> ${data.username}</p>
        <p><strong>Contrase√±a:</strong> ${data.password}</p>
        <p class="aviso">‚ö† Funciona hasta que lo elimines manualmente.</p>
      </div>
    `;

  } catch (err) {
    resultadoDemo.style.display = "block";
    resultadoDemo.innerHTML = `<p style="color:red;">Error creando demo</p>`;
  }

  btnCrearDemo.disabled = false;
  btnCrearDemo.textContent = "üß™ Crear usuario demo";
};


}

async function initBajaClosers() {

  const container = document.getElementById("listaBajaClosers");

  try {

    const res = await fetch(
      "https://stripe-backend-h1z1.vercel.app/api/list-baja-closers"
    );

    const closers = await res.json();

    if (!res.ok) {
      container.innerHTML = "<p>Error cargando closers</p>";
      return;
    }

    if (closers.length === 0) {
      container.innerHTML = "<p>No hay closers activos.</p>";
      return;
    }

    container.innerHTML = "";

    closers.forEach(closer => {

      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.alignItems = "center";
      row.style.justifyContent = "space-between";
      row.style.padding = "14px 20px";
      row.style.marginBottom = "12px";
      row.style.background = "rgba(15,10,35,0.85)";
      row.style.borderRadius = "14px";
      row.style.backdropFilter = "blur(10px)";

      const left = document.createElement("div");
      left.innerHTML = `
        <strong>${closer.username}</strong>
        <div style="font-size:12px;opacity:0.7;">ID: ${closer.id}</div>
      `;

      const button = document.createElement("button");
      button.textContent = closer.is_active ? "Dar de baja" : "Volver a dar de alta";
      button.style.padding = "8px 14px";
      button.style.borderRadius = "10px";
      button.style.border = "none";
      button.style.cursor = "pointer";
      button.style.fontWeight = "600";
      button.style.background = closer.is_active
        ? "linear-gradient(90deg,#ff3b00,#ff6a00)"
        : "linear-gradient(90deg,#16a34a,#22c55e)";
      button.style.color = "#fff";

      if (!closer.is_active) {
        const status = document.createElement("div");
        status.textContent = "Dado de baja";
        status.style.fontSize = "12px";
        status.style.color = "#fbbf24";
        status.style.marginTop = "4px";
        left.appendChild(status);
      }

      button.onclick = async () => {

        button.disabled = true;

        await fetch(
          "https://stripe-backend-h1z1.vercel.app/api/toggle-baja-closer",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: closer.id })
          }
        );

        initBajaClosers(); // refresca lista
      };

      row.appendChild(left);
      row.appendChild(button);
      container.appendChild(row);
    });

  } catch {
    container.innerHTML = "<p>Error servidor</p>";
  }
}

async function initClosersSection() {

  const container = document.getElementById("listaClosers");

  try {

    const res = await fetch(
      "https://stripe-backend-h1z1.vercel.app/api/list-closers"
    );

    const closers = await res.json();

    if (!res.ok) {
      container.innerHTML = "<p>Error cargando closers</p>";
      return;
    }

    if (closers.length === 0) {
      container.innerHTML = "<p>No hay closers.</p>";
      return;
    }

    container.innerHTML = "";

    closers.forEach(closer => {

      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.flexDirection = "column";
      row.style.padding = "14px 20px";
      row.style.marginBottom = "12px";
      row.style.background = "rgba(15,10,35,0.85)";
      row.style.borderRadius = "14px";
      row.style.backdropFilter = "blur(10px)";
      row.style.cursor = "pointer";

      const header = document.createElement("div");
      header.style.display = "flex";
      header.style.alignItems = "center";
      header.style.justifyContent = "space-between";

      const left = document.createElement("div");
      left.innerHTML = `
        <strong>${closer.username}</strong>
        <div style="font-size:12px;opacity:0.7;">ID: ${closer.id}</div>
      `;

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.alignItems = "center";
      right.style.gap = "15px";

      const statusDot = document.createElement("div");
      statusDot.style.width = "10px";
      statusDot.style.height = "10px";
      statusDot.style.borderRadius = "50%";
      statusDot.style.background = closer.is_active ? "#22c55e" : "#ef4444";

      const statusText = document.createElement("span");
      statusText.textContent = closer.is_active ? "Activo" : "Inactivo";
      statusText.style.fontSize = "13px";

      right.appendChild(statusDot);
      right.appendChild(statusText);

      const ahora = new Date();
const bajaDate = closer.baja_at ? new Date(closer.baja_at) : null;

const puedeEliminar =
  closer.is_demo ||
  (
    !closer.is_demo &&
    !closer.is_active &&
    bajaDate &&
    (ahora - bajaDate) > 3600000
  );

if (puedeEliminar) {

  const deleteBtn = document.createElement("div");
  deleteBtn.textContent = "üóë";
  deleteBtn.style.cursor = "pointer";
  deleteBtn.style.fontSize = "18px";

  deleteBtn.onclick = async (e) => {
    e.stopPropagation();

    await fetch(
      "https://stripe-backend-h1z1.vercel.app/api/delete-closer",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: closer.id })
      }
    );

    initClosersSection();
  };

  right.appendChild(deleteBtn);
}

      header.appendChild(left);
      header.appendChild(right);

      const details = document.createElement("div");
      details.style.display = "none";
      details.style.marginTop = "12px";
      details.style.fontSize = "13px";
      details.style.opacity = "0.85";
      
      // Estado contractual (Alta / Baja)

const estadoContainer = document.createElement("div");
estadoContainer.style.marginBottom = "10px";
estadoContainer.style.fontWeight = "600";
estadoContainer.style.display = "flex";
estadoContainer.style.alignItems = "center";
estadoContainer.style.gap = "8px";

const estadoDot = document.createElement("div");
estadoDot.style.width = "10px";
estadoDot.style.height = "10px";
estadoDot.style.borderRadius = "50%";

const estadoTexto = document.createElement("span");

if (closer.is_active) {
  estadoDot.style.background = "#22c55e";
  estadoTexto.textContent = "Alta activa";
} else {
  estadoDot.style.background = "#ef4444";
  estadoTexto.textContent = "Dado de baja";
}

estadoContainer.appendChild(estadoDot);
estadoContainer.appendChild(estadoTexto);

details.appendChild(estadoContainer);
// =============================
// Comisi√≥n din√°mica
// =============================

let commissionText = "--";

if (closer.is_active && closer.commission_start_at) {

  const start = new Date(closer.commission_start_at);
  const now = new Date();

  const diffMonths =
    (now.getFullYear() - start.getFullYear()) * 12 +
    (now.getMonth() - start.getMonth());

  if (diffMonths <= 0) {
    commissionText = "50%";
  } else if (diffMonths === 1) {
    commissionText = "35%";
  } else {
    commissionText = "25%";
  }
}

const commissionContainer = document.createElement("div");
commissionContainer.style.marginBottom = "8px";
commissionContainer.innerHTML = `
  <strong>Comisi√≥n actual:</strong> ${commissionText}
`;

details.appendChild(commissionContainer);

// =============================
// Tel√©fono (si existe)
// =============================

if (closer.phone) {

  const phoneContainer = document.createElement("div");
  phoneContainer.style.marginBottom = "8px";
  phoneContainer.innerHTML = `
    <strong>Tel√©fono:</strong> ${closer.phone}
  `;

  details.appendChild(phoneContainer);
}

      function formatDate(dateString, timeZone) {

  if (!dateString) return { date: "--", time: "--" };

  const dateObj = new Date(dateString);

  const date = dateObj.toLocaleDateString("es-ES", {
    timeZone,
    year: "numeric",
    month: "2-digit",
    day: "2-digit"
  });

  const time = dateObj.toLocaleTimeString("es-ES", {
    timeZone,
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit"
  });

  return { date, time };
}


const countrySelect = document.createElement("select");
countrySelect.style.marginTop = "8px";
countrySelect.style.fontSize = "12px";
countrySelect.style.padding = "4px";
countrySelect.style.borderRadius = "6px";

countrySelect.onclick = (e) => e.stopPropagation();
countrySelect.onmousedown = (e) => e.stopPropagation();

const countries = [
  { name: "Espa√±a", zone: "Europe/Madrid" },
  { name: "Reino Unido", zone: "Europe/London" },
  { name: "Estados Unidos - Nueva York", zone: "America/New_York" },
  { name: "Estados Unidos - Los Angeles", zone: "America/Los_Angeles" },
  { name: "Rusia - Mosc√∫", zone: "Europe/Moscow" },
  { name: "Dubai", zone: "Asia/Dubai" },
  { name: "M√©xico", zone: "America/Mexico_City" },
  { name: "Argentina", zone: "America/Argentina/Buenos_Aires" },
  { name: "Colombia", zone: "America/Bogota" },
  { name: "UTC", zone: "UTC" }
];

countries.forEach(c => {
  const option = document.createElement("option");
  option.value = c.zone;
  option.textContent = c.name;
  countrySelect.appendChild(option);
});


const altaContainer = document.createElement("div");
const bajaContainer = document.createElement("div");

function renderDates() {

  const zone = countrySelect.value;

  const alta = formatDate(closer.created_at, zone);
  const baja = formatDate(closer.baja_at, zone);

  altaContainer.innerHTML = `
    <strong>Fecha alta</strong><br>
    ${alta.date}<br>
    ${alta.time}
  `;

  bajaContainer.innerHTML = `
    <strong>Fecha baja</strong><br>
    ${baja.date}<br>
    ${baja.time}
  `;
}

countrySelect.onchange = renderDates;

renderDates();

details.appendChild(countrySelect);
details.appendChild(altaContainer);
details.appendChild(bajaContainer);

      row.appendChild(header);
      row.appendChild(details);

      header.onclick = () => {
        details.style.display =
          details.style.display === "none" ? "block" : "none";
      };

      container.appendChild(row);
    });

  } catch {
    container.innerHTML = "<p>Error servidor</p>";
  }
}
</script>


</body>
</html>