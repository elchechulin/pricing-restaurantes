<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Administrador</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="style.css">

  <style>
    body {
  margin: 0;
  font-family: Arial, sans-serif;
  overflow-x: hidden;
}

    /* ===== HEADER ===== */
    .topbar {
      height: 60px;
      background: #020617;
      display: flex;
      align-items: center;
      padding: 0 20px;
      border-bottom: 1px solid #1e293b;
    }

    .menu-btn {
      font-size: 22px;
      cursor: pointer;
      background: none;
      border: none;
      color: #f8fafc;
    }

    .title {
      margin-left: 15px;
      font-weight: 600;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      position: fixed;
      top: 0;
      left: -260px;
      width: 260px;
      height: 100%;
      background: #020617;
      border-right: 1px solid #1e293b;
      transition: left 0.3s ease;
      padding-top: 60px;
      z-index: 1000;
    }

    .sidebar.active {
      left: 0;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar li {
      padding: 15px 20px;
      cursor: pointer;
      border-bottom: 1px solid #1e293b;
      transition: background 0.2s;
    }

    .sidebar li:hover {
      background: #1e293b;
    }

    .sidebar li span {
      margin-right: 10px;
    }

    /* ===== CONTENT ===== */
    .content {
      padding: 30px;
      transition: margin-left 0.3s ease;
    }

    .content.shift {
      margin-left: 260px;
    }
  </style>
</head>

<body>

  <div class="topbar">
    <button class="menu-btn" id="menuBtn">‚ò∞</button>
    <div class="title">Panel Administrador</div>
  </div>

  <div class="sidebar" id="sidebar">
    <ul>
      <li data-section="dashboard"><span>üìä</span>Dashboard</li>
      <li data-section="alta"><span>‚ûï</span>Alta de closers</li>
      <li data-section="baja"><span>‚ûñ</span>Baja de closers</li>
      <li data-section="closers"><span>üë§</span>Closers</li>
      <li data-section="ventas"><span>üí∞</span>Ventas</li>
      <li data-section="pagos"><span>üßæ</span>Pago mensual closers</li>
      <li data-section="historico"><span>üìÅ</span>Historico total</li>
      <li data-section="idioma"><span>üåç</span>Idioma</li>
      <li id="logoutBtn"><span>üö™</span>Logout</li>
    </ul>
  </div>

  <div class="content" id="contentArea">

  <!-- CONTENEDOR DIN√ÅMICO -->
  <div id="adminSection"></div>

</div>

<script src="auth.js"></script>

<script>
  const menuBtn = document.getElementById("menuBtn");
  const sidebar = document.getElementById("sidebar");
  const content = document.getElementById("contentArea");
  
  const adminSection = document.getElementById("adminSection");
  
  let closerAbiertoId = null;

async function loadSection(section) {

  if (section === "dashboard") {

    const res = await fetch("dashboard.html");
    const html = await res.text();
    adminSection.innerHTML = html;

    // Eliminar app.js anterior si existe
    const oldScript = document.querySelector("script[data-appjs]");
    if (oldScript) oldScript.remove();

    // Crear script nuevo
    const script = document.createElement("script");
    script.src = "app.js";
    script.setAttribute("data-appjs", "true");

    script.onload = function () {
      if (typeof initPricingApp === "function") {
        initPricingApp();
      }
    };

    document.body.appendChild(script);

  } else if (section === "alta") {

  adminSection.innerHTML = `
    <div class="alta-container">

      <button id="btnNuevoCloser" class="btn-nuevo-closer">
        ‚ûï Dar de alta nuevo closer
      </button>
      
      <button id="btnCrearDemoCloser" class="btn-nuevo-closer" style="margin-top:12px; background:#111;">
  üß™ Crear usuario demo
</button>

<div id="resultadoDemo" style="display:none;margin-top:15px;"></div>

<div id="demoCloserPanel" style="display:none;margin-top:25px;">
  <div class="card-credenciales">
    <h3>Simulaci√≥n de trabajo del closer</h3>
    <ol style="margin-top:10px;line-height:1.6;">
      <li>1Ô∏è‚É£ Inicia sesi√≥n con su usuario.</li>
      <li>2Ô∏è‚É£ Accede al motor de pricing.</li>
      <li>3Ô∏è‚É£ Calcula precio al restaurante.</li>
      <li>4Ô∏è‚É£ Genera enlace de pago.</li>
      <li>5Ô∏è‚É£ Cuando el cliente paga, la venta se registra autom√°ticamente.</li>
      <li>6Ô∏è‚É£ La comisi√≥n se acumula para el cierre mensual.</li>
    </ol>
    <p class="aviso">
      ‚ö† Esta es una simulaci√≥n visual. No crea datos reales.
    </p>
  </div>
</div>

      <div id="formAltaCloser" class="form-alta-closer" style="display:none;">
        
        <label>Nombre completo
          <input type="text" id="nuevoNombre" placeholder="Ej. Ismael Guerra">
        </label>

        <label>Municipio
          <input type="text" id="nuevoMunicipio" placeholder="Ej. Madrid">
        </label>

        <label>Tel√©fono
          <input type="text" id="nuevoTelefono" placeholder="Ej. +34 600 000 000">
        </label>

        <button id="btnCrearCloser" class="btn-crear-closer">
          Crear closer
        </button>

        <div id="resultadoAlta" class="resultado-alta" style="display:none;"></div>

      </div>

    </div>
  `;

  setTimeout(initAltaCloser, 0);

} else if (section === "baja") {

  adminSection.innerHTML = `
    <div style="max-width:1000px;margin:30px auto;">
      <h2 style="margin-bottom:25px;">Closers activos</h2>
      <div id="listaBajaClosers"></div>
    </div>
  `;

  setTimeout(initBajaClosers, 0);

} else if (section === "closers") {

  adminSection.innerHTML = `
    <div style="max-width:1000px;margin:30px auto;">
      <h2 style="margin-bottom:25px;">Gesti√≥n de Closers</h2>
      <div id="listaClosers"></div>
    </div>
  `;

  setTimeout(initClosersSection, 0);

} else if (section === "ventas") {

  adminSection.innerHTML = `
    <div style="max-width:1200px;margin:30px auto;">

      <h2 style="margin-bottom:25px;">üìä Ventas</h2>

      <!-- FILTROS -->
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:25px;">

        <select id="filtroView">
          <option value="active">Activos</option>
          <option value="disabled">Desactivados</option>
        </select>

        <select id="filtroMes"></select>

        <select id="filtroYear"></select>

        <select id="filtroCloser">
          <option value="">Todos los closers</option>
        </select>

        <button id="btnFiltrarVentas">Filtrar</button>

      </div>

      <!-- KPIs -->
      <div id="ventasKPIs" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:30px;"></div>

      <!-- TABLA -->
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:#111;color:#fff;">
              <th style="padding:10px;">Fecha</th>
              <th style="padding:10px;">Closer</th>
              <th style="padding:10px;">Servicio</th>
              <th style="padding:10px;">Precio</th>
              <th style="padding:10px;">Comisi√≥n</th>
              <th style="padding:10px;">Estado</th>
            </tr>
          </thead>
          <tbody id="ventasTabla"></tbody>
        </table>
      </div>

    </div>
  `;

  setTimeout(initVentasSection, 0);

}
}

  function toggleMenu() {
    sidebar.classList.toggle("active");
    content.classList.toggle("shift");
  }

  function closeMenu() {
    sidebar.classList.remove("active");
    content.classList.remove("shift");
  }

  // Bot√≥n hamburguesa abre y cierra
  menuBtn.onclick = (e) => {
    e.stopPropagation();
    toggleMenu();
  };

  // Cerrar si haces click fuera del men√∫
  document.addEventListener("click", (e) => {
    if (
      sidebar.classList.contains("active") &&
      !sidebar.contains(e.target) &&
      e.target !== menuBtn
    ) {
      closeMenu();
    }
  });

  // Cerrar al hacer click en una opci√≥n
  document.querySelectorAll(".sidebar li").forEach(item => {
  item.addEventListener("click", () => {

    if (item.id === "logoutBtn") return;

    const section = item.dataset.section;
    if (section) {
      loadSection(section);
    }

    closeMenu();
  });
});

  // Logout
  document.getElementById("logoutBtn").onclick = () => {
    localStorage.clear();
    window.location.href = "login.html";
  };
  
  // Cargar Dashboard por defecto al entrar
loadSection("dashboard");

function initAltaCloser() {

  const btnNuevo = document.getElementById("btnNuevoCloser");
  const form = document.getElementById("formAltaCloser");
  const btnCrear = document.getElementById("btnCrearCloser");
  const resultado = document.getElementById("resultadoAlta");
  const resultadoDemo = document.getElementById("resultadoDemo");

  const btnCrearDemo = document.getElementById("btnCrearDemoCloser");

  // Mostrar formulario alta real
  btnNuevo.onclick = () => {
    form.style.display = "block";
  };

  // Crear closer REAL
  btnCrear.onclick = async () => {

    const full_name = document.getElementById("nuevoNombre").value.trim();
    const city = document.getElementById("nuevoMunicipio").value.trim();
    const phone = document.getElementById("nuevoTelefono").value.trim();

    if (!full_name || !city) {
      resultado.style.display = "block";
      resultado.innerHTML = `<p style="color:red;">Nombre y municipio son obligatorios</p>`;
      return;
    }

    btnCrear.disabled = true;
    btnCrear.textContent = "Creando...";

    try {

      const res = await fetch(
        "https://stripe-backend-h1z1.vercel.app/api/create-closer",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ full_name, city, phone })
        }
      );

      const data = await res.json();

      if (!res.ok) {
        resultado.style.display = "block";
        resultado.innerHTML = `<p style="color:red;">${data.error}</p>`;
        btnCrear.disabled = false;
        btnCrear.textContent = "Crear closer";
        return;
      }

      resultado.style.display = "block";
      resultado.innerHTML = `
        <div class="card-credenciales">
          <h3>Closer creado correctamente</h3>
          <p><strong>Usuario:</strong> ${data.username}</p>
          <p><strong>Contrase√±a:</strong> ${data.password}</p>
          <p class="aviso">‚ö† Copia estas credenciales ahora. No volver√°n a mostrarse.</p>
        </div>
      `;

      setTimeout(() => {
        resultado.style.display = "none";
      }, 3600000);

    } catch {
      resultado.style.display = "block";
      resultado.innerHTML = `<p style="color:red;">Error servidor</p>`;
    }

    btnCrear.disabled = false;
    btnCrear.textContent = "Crear closer";
  };

  // Crear usuario DEMO
btnCrearDemo.onclick = async () => {

  btnCrearDemo.disabled = true;
  btnCrearDemo.textContent = "Creando demo...";

  try {

    const res = await fetch(
      "https://stripe-backend-h1z1.vercel.app/api/create-demo-closer",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
      }
    );

    const data = await res.json();

    if (!res.ok) {
      resultadoDemo.style.display = "block";
      resultadoDemo.innerHTML = `<p style="color:red;">${data.error || "Error creando demo"}</p>`;
      return;
    }

    resultadoDemo.style.display = "block";
    resultadoDemo.innerHTML = `
      <div class="card-credenciales">
        <h3>Usuario demo creado</h3>
        <p><strong>Usuario:</strong> ${data.username}</p>
        <p><strong>Contrase√±a:</strong> ${data.password}</p>
        <p class="aviso">‚ö† Funciona hasta que lo elimines manualmente.</p>
      </div>
    `;

  } catch (err) {
    resultadoDemo.style.display = "block";
    resultadoDemo.innerHTML = `<p style="color:red;">Error creando demo</p>`;
  }

  btnCrearDemo.disabled = false;
  btnCrearDemo.textContent = "üß™ Crear usuario demo";
};


}

async function initBajaClosers() {

  const container = document.getElementById("listaBajaClosers");

  try {

    const res = await fetch(
      "https://stripe-backend-h1z1.vercel.app/api/list-baja-closers"
    );

    const closers = await res.json();

    if (!res.ok) {
      container.innerHTML = "<p>Error cargando closers</p>";
      return;
    }

    if (closers.length === 0) {
      container.innerHTML = "<p>No hay closers activos.</p>";
      return;
    }

    container.innerHTML = "";

    closers.forEach(closer => {

      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.alignItems = "center";
      row.style.justifyContent = "space-between";
      row.style.padding = "14px 20px";
      row.style.marginBottom = "12px";
      row.style.background = "rgba(15,10,35,0.85)";
      row.style.borderRadius = "14px";
      row.style.backdropFilter = "blur(10px)";

      const left = document.createElement("div");
      left.innerHTML = `
        <strong>${closer.username}</strong>
        <div style="font-size:12px;opacity:0.7;">ID: ${closer.id}</div>
      `;

      const button = document.createElement("button");
      button.textContent = closer.is_active ? "Dar de baja" : "Volver a dar de alta";
      button.style.padding = "8px 14px";
      button.style.borderRadius = "10px";
      button.style.border = "none";
      button.style.cursor = "pointer";
      button.style.fontWeight = "600";
      button.style.background = closer.is_active
        ? "linear-gradient(90deg,#ff3b00,#ff6a00)"
        : "linear-gradient(90deg,#16a34a,#22c55e)";
      button.style.color = "#fff";

      if (!closer.is_active) {
        const status = document.createElement("div");
        status.textContent = "Dado de baja";
        status.style.fontSize = "12px";
        status.style.color = "#fbbf24";
        status.style.marginTop = "4px";
        left.appendChild(status);
      }

      button.onclick = async () => {

        button.disabled = true;

        await fetch(
          "https://stripe-backend-h1z1.vercel.app/api/toggle-baja-closer",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: closer.id })
          }
        );

        initBajaClosers(); // refresca lista
      };

      row.appendChild(left);
      row.appendChild(button);
      container.appendChild(row);
    });

  } catch {
    container.innerHTML = "<p>Error servidor</p>";
  }
}

async function initClosersSection() {

  const container = document.getElementById("listaClosers");

  try {

    const res = await fetch(
      "https://stripe-backend-h1z1.vercel.app/api/list-closers"
    );

    const closers = await res.json();

    if (!res.ok) {
      container.innerHTML = "<p>Error cargando closers</p>";
      return;
    }

    if (closers.length === 0) {
      container.innerHTML = "<p>No hay closers.</p>";
      return;
    }

    container.innerHTML = "";

    closers.forEach(closer => {

      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.flexDirection = "column";
      row.style.padding = "14px 20px";
      row.style.marginBottom = "12px";
      row.style.background = "rgba(15,10,35,0.85)";
      row.style.borderRadius = "14px";
      row.style.backdropFilter = "blur(10px)";
      row.style.cursor = "pointer";

      const header = document.createElement("div");
      header.style.display = "flex";
      header.style.alignItems = "center";
      header.style.justifyContent = "space-between";

      const left = document.createElement("div");
      left.innerHTML = `
        <strong>${closer.username}</strong>
        <div style="font-size:12px;opacity:0.7;">ID: ${closer.id}</div>
      `;

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.alignItems = "center";
      right.style.gap = "15px";

      // =============================
// üü¢ ONLINE / OFFLINE + ACTIVO
// =============================

const statusContainer = document.createElement("div");
statusContainer.style.display = "flex";
statusContainer.style.alignItems = "center";
statusContainer.style.gap = "6px";
statusContainer.style.fontSize = "13px";

const onlineDot = document.createElement("div");
onlineDot.setAttribute("data-online-dot", closer.id);
onlineDot.style.width = "8px";
onlineDot.style.height = "8px";
onlineDot.style.borderRadius = "50%";
onlineDot.style.background = closer.online ? "#22c55e" : "#6b7280";

const onlineText = document.createElement("span");
onlineText.setAttribute("data-online-text", closer.id);
onlineText.textContent = closer.online ? "Online" : "Offline";

const activeText = document.createElement("span");
activeText.style.marginLeft = "6px";
activeText.style.opacity = "0.8";
activeText.textContent = closer.is_active ? "¬∑ Activo" : "¬∑ Inactivo";

statusContainer.appendChild(onlineDot);
statusContainer.appendChild(onlineText);
statusContainer.appendChild(activeText);

right.appendChild(statusContainer);

      const ahora = new Date();
const bajaDate = closer.baja_at ? new Date(closer.baja_at) : null;

const puedeEliminar =
  closer.is_demo ||
  (
    !closer.is_demo &&
    !closer.is_active &&
    bajaDate &&
    (ahora - bajaDate) > 3600000
  );

if (puedeEliminar) {

  const deleteBtn = document.createElement("div");
  deleteBtn.textContent = "üóë";
  deleteBtn.style.cursor = "pointer";
  deleteBtn.style.fontSize = "18px";

  deleteBtn.onclick = async (e) => {
    e.stopPropagation();

    await fetch(
      "https://stripe-backend-h1z1.vercel.app/api/delete-closer",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: closer.id })
      }
    );

    initClosersSection();
  };

  right.appendChild(deleteBtn);
}

      header.appendChild(left);
      header.appendChild(right);

      const details = document.createElement("div");
      details.setAttribute("data-closer-details", closer.id);
      details.style.display = "none";
      details.style.marginTop = "12px";
      details.style.fontSize = "13px";
      details.style.opacity = "0.85";
      
      // Estado contractual (Alta / Baja)

const estadoContainer = document.createElement("div");
estadoContainer.style.marginBottom = "10px";
estadoContainer.style.fontWeight = "600";
estadoContainer.style.display = "flex";
estadoContainer.style.alignItems = "center";
estadoContainer.style.gap = "8px";

const estadoDot = document.createElement("div");
estadoDot.style.width = "10px";
estadoDot.style.height = "10px";
estadoDot.style.borderRadius = "50%";

const estadoTexto = document.createElement("span");

if (closer.is_active) {
  estadoDot.style.background = "#22c55e";
  estadoTexto.textContent = "Alta activa";
} else {
  estadoDot.style.background = "#ef4444";
  estadoTexto.textContent = "Dado de baja";
}

estadoContainer.appendChild(estadoDot);
estadoContainer.appendChild(estadoTexto);

details.appendChild(estadoContainer);
// =============================
// Comisi√≥n din√°mica
// =============================

let commissionText = "--";

if (closer.is_active && closer.commission_start_at) {

  const start = new Date(closer.commission_start_at);
  const now = new Date();

  const diffMonths =
    (now.getFullYear() - start.getFullYear()) * 12 +
    (now.getMonth() - start.getMonth());

  if (diffMonths <= 0) {
    commissionText = "50%";
  } else if (diffMonths === 1) {
    commissionText = "35%";
  } else {
    commissionText = "25%";
  }
}

const commissionContainer = document.createElement("div");
commissionContainer.style.marginBottom = "8px";
commissionContainer.innerHTML = `
  <strong>Comisi√≥n actual:</strong> ${commissionText}
`;

details.appendChild(commissionContainer);

// =============================
// Tel√©fono (si existe)
// =============================

if (closer.phone) {

  const phoneContainer = document.createElement("div");
  phoneContainer.style.marginBottom = "8px";
  phoneContainer.innerHTML = `
    <strong>Tel√©fono:</strong> ${closer.phone}
  `;

  details.appendChild(phoneContainer);
}

      function formatDate(dateString, timeZone) {

  if (!dateString) return { date: "--", time: "--" };

  const dateObj = new Date(dateString);

  const date = dateObj.toLocaleDateString("es-ES", {
    timeZone,
    year: "numeric",
    month: "2-digit",
    day: "2-digit"
  });

  const time = dateObj.toLocaleTimeString("es-ES", {
    timeZone,
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit"
  });

  return { date, time };
}


const countrySelect = document.createElement("select");
countrySelect.style.marginTop = "8px";
countrySelect.style.fontSize = "12px";
countrySelect.style.padding = "4px";
countrySelect.style.borderRadius = "6px";

countrySelect.onclick = (e) => e.stopPropagation();
countrySelect.onmousedown = (e) => e.stopPropagation();

const countries = [
  { name: "Espa√±a", zone: "Europe/Madrid" },
  { name: "Reino Unido", zone: "Europe/London" },
  { name: "Estados Unidos - Nueva York", zone: "America/New_York" },
  { name: "Estados Unidos - Los Angeles", zone: "America/Los_Angeles" },
  { name: "Rusia - Mosc√∫", zone: "Europe/Moscow" },
  { name: "Dubai", zone: "Asia/Dubai" },
  { name: "M√©xico", zone: "America/Mexico_City" },
  { name: "Argentina", zone: "America/Argentina/Buenos_Aires" },
  { name: "Colombia", zone: "America/Bogota" },
  { name: "UTC", zone: "UTC" }
];

countries.forEach(c => {
  const option = document.createElement("option");
  option.value = c.zone;
  option.textContent = c.name;
  countrySelect.appendChild(option);
});


const altaContainer = document.createElement("div");
const bajaContainer = document.createElement("div");

function renderDates() {

  const zone = countrySelect.value;

  const alta = formatDate(closer.created_at, zone);
  const baja = formatDate(closer.baja_at, zone);

  altaContainer.innerHTML = `
    <strong>Fecha alta</strong><br>
    ${alta.date}<br>
    ${alta.time}
  `;

  bajaContainer.innerHTML = `
    <strong>Fecha baja</strong><br>
    ${baja.date}<br>
    ${baja.time}
  `;
}

countrySelect.onchange = renderDates;

renderDates();

details.appendChild(countrySelect);
details.appendChild(altaContainer);
details.appendChild(bajaContainer);
// =============================
// üìä BLOQUE RENDIMIENTO
// =============================

const rendimientoContainer = document.createElement("div");
rendimientoContainer.style.marginTop = "18px";
rendimientoContainer.style.paddingTop = "12px";
rendimientoContainer.style.borderTop = "1px solid rgba(255,255,255,0.1)";

rendimientoContainer.innerHTML = `
  <div style="font-weight:700;margin-bottom:8px;">üìä Rendimiento</div>
  <div><strong>Total ventas:</strong> ${closer.total_sales}</div>
  <div><strong>Distribuci√≥n:</strong></div>
  <div style="font-size:12px;opacity:0.8;">
    Low: ${closer.low_percentage}%<br>
    Medium: ${closer.medium_percentage}%<br>
    High: ${closer.high_percentage}%
  </div>
  <div style="margin-top:6px;">
    <strong>Ticket medio:</strong> ${Number(closer.avg_ticket).toFixed(2)} ‚Ç¨
  </div>
`;

details.appendChild(rendimientoContainer);


// =============================
// üü¢ BLOQUE ACTIVIDAD
// =============================

function formatActivity(dateString) {
  if (!dateString) return "--";
  const d = new Date(dateString);
  return d.toLocaleString("es-ES");
}

const actividadContainer = document.createElement("div");
actividadContainer.style.marginTop = "18px";
actividadContainer.style.paddingTop = "12px";
actividadContainer.style.borderTop = "1px solid rgba(255,255,255,0.1)";

actividadContainer.innerHTML = `
  <div style="font-weight:700;margin-bottom:8px;">üü¢ Actividad</div>
  <div><strong>√öltimo login:</strong> ${formatActivity(closer.last_login)}</div>
  <div><strong>√öltima actividad:</strong> ${formatActivity(closer.last_activity)}</div>
`;

details.appendChild(actividadContainer);


// =============================
// ‚öñ BLOQUE LEGAL (PREPARADO)
// =============================

const legalContainer = document.createElement("div");
legalContainer.style.marginTop = "18px";
legalContainer.style.paddingTop = "12px";
legalContainer.style.borderTop = "1px solid rgba(255,255,255,0.1)";

let contratoHTML = "<div><strong>Contrato:</strong> No firmado</div>";

if (closer.contract_signed_at) {
  contratoHTML = `
    <div><strong>Contrato firmado:</strong> ${formatActivity(closer.contract_signed_at)}</div>
    <div><strong>Versi√≥n:</strong> ${closer.contract_version || "--"}</div>
    <div>
      <strong>Documento:</strong>
      ${closer.contract_url 
        ? `<a href="${closer.contract_url}" target="_blank" style="color:#60a5fa;">Ver contrato</a>`
        : "Pendiente"}
    </div>
  `;
}

legalContainer.innerHTML = `
  <div style="font-weight:700;margin-bottom:8px;">‚öñ Legal</div>
  ${contratoHTML}
`;

details.appendChild(legalContainer);
// =============================
// üîê BOT√ìN RESTABLECER PASSWORD
// =============================

if (!closer.is_demo) {

  const resetBtn = document.createElement("button");
  resetBtn.textContent = "üîê Restablecer contrase√±a";
  resetBtn.style.marginTop = "15px";
  resetBtn.style.padding = "8px 12px";
  resetBtn.style.borderRadius = "8px";
  resetBtn.style.border = "none";
  resetBtn.style.cursor = "pointer";
  resetBtn.style.fontWeight = "600";
  resetBtn.style.background = "#1e293b";
  resetBtn.style.color = "#fff";

  resetBtn.onclick = async (e) => {
    e.stopPropagation();

    const adminPassword = prompt("Introduce tu contrase√±a de administrador:");

    if (!adminPassword) return;

    try {

      const res = await fetch(
        "https://stripe-backend-h1z1.vercel.app/api/login",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            mode: "reset_password",
            user_id: closer.id,
            admin_password: adminPassword
          })
        }
      );

      const data = await res.json();

      if (!res.ok) {
        alert(data.error || "Error restableciendo contrase√±a");
        return;
      }

      alert("Nueva contrase√±a: " + data.new_password);

    } catch (err) {
      alert("Error servidor");
    }
  };

  details.appendChild(resetBtn);
}

      row.appendChild(header);
      row.appendChild(details);

      header.onclick = () => {

  const estaAbierto = details.style.display === "block";

  // Cerrar todos antes
  document.querySelectorAll("[data-closer-details]").forEach(el => {
    el.style.display = "none";
  });

  if (!estaAbierto) {
    details.style.display = "block";
    closerAbiertoId = closer.id;
  } else {
    details.style.display = "none";
    closerAbiertoId = null;
  }
};

      container.appendChild(row);
      // Si este era el que estaba abierto, volver a abrirlo
if (closerAbiertoId === closer.id) {
  details.style.display = "block";
}
    });

  } catch {
    container.innerHTML = "<p>Error servidor</p>";
  }


}

async function initVentasSection() {

  const selectMes = document.getElementById("filtroMes");
  const selectYear = document.getElementById("filtroYear");
  const selectCloser = document.getElementById("filtroCloser");

  const meses = [
    "Todos","Enero","Febrero","Marzo","Abril","Mayo","Junio",
    "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
  ];

  meses.forEach((m,i) => {
    const opt = document.createElement("option");
    opt.value = i === 0 ? "" : i;
    opt.textContent = m;
    selectMes.appendChild(opt);
  });

  const yearActual = new Date().getFullYear();
  for (let y = yearActual; y >= 2023; y--) {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    selectYear.appendChild(opt);
  }

  try {
    const resClosers = await fetch("https://stripe-backend-h1z1.vercel.app/api/list-closers");
    const closers = await resClosers.json();

    closers.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.username;
      selectCloser.appendChild(opt);
    });

  } catch {}

  document.getElementById("btnFiltrarVentas").onclick = cargarVentas;

  cargarVentas();
}

async function cargarVentas() {

  const view = document.getElementById("filtroView").value;
  const month = document.getElementById("filtroMes").value;
  const year = document.getElementById("filtroYear").value;
  const closer = document.getElementById("filtroCloser").value;

  let url = `https://stripe-backend-h1z1.vercel.app/api/health?type=sales&view=${view}`;

  if (month) url += `&month=${month}`;
  if (year) url += `&year=${year}`;
  if (closer) url += `&closer_id=${closer}`;

  try {

    const res = await fetch(url);
    const data = await res.json();

    if (!res.ok) {
      alert("Error cargando ventas");
      return;
    }

    renderKPIs(data.kpis);
    renderTabla(data.sales);

  } catch {
    alert("Error servidor ventas");
  }
}

function renderKPIs(kpis) {

  const container = document.getElementById("ventasKPIs");

  container.innerHTML = `
    <div style="background:#111;color:#fff;padding:20px;border-radius:12px;">
      <div>Total ventas</div>
      <strong style="font-size:22px;">${kpis.total_sales}</strong>
    </div>

    <div style="background:#111;color:#fff;padding:20px;border-radius:12px;">
      <div>Facturaci√≥n</div>
      <strong style="font-size:22px;">${Number(kpis.total_revenue).toFixed(2)} ‚Ç¨</strong>
    </div>

    <div style="background:#111;color:#fff;padding:20px;border-radius:12px;">
      <div>Comisiones</div>
      <strong style="font-size:22px;">${Number(kpis.total_commissions).toFixed(2)} ‚Ç¨</strong>
    </div>

    <div style="background:#111;color:#fff;padding:20px;border-radius:12px;">
      <div>Ticket medio</div>
      <strong style="font-size:22px;">${Number(kpis.avg_ticket).toFixed(2)} ‚Ç¨</strong>
    </div>
  `;
}

function renderTabla(ventas) {

  const tbody = document.getElementById("ventasTabla");
  tbody.innerHTML = "";

  if (!ventas.length) {
    tbody.innerHTML = `<tr><td colspan="6" style="padding:15px;text-align:center;">Sin resultados</td></tr>`;
    return;
  }

  ventas.forEach(v => {

    const row = document.createElement("tr");
    row.style.borderBottom = "1px solid #ddd";

    row.innerHTML = `
      <td style="padding:10px;">${new Date(v.created_at).toLocaleDateString()}</td>
      <td style="padding:10px;">${v.username || "-"}</td>
      <td style="padding:10px;">${v.service_type}</td>
      <td style="padding:10px;">${v.monthly_price} ‚Ç¨</td>
      <td style="padding:10px;">${(v.monthly_price * v.commission_percentage / 100).toFixed(2)} ‚Ç¨</td>
      <td style="padding:10px;">${v.subscription_status}</td>
    `;

    tbody.appendChild(row);
  });
}
// ======================================
// üîÑ REFRESH SOLO ONLINE / OFFLINE
// ======================================

async function refreshOnlineStatus() {

  try {

    const res = await fetch(
      "https://stripe-backend-h1z1.vercel.app/api/list-closers"
    );

    const closers = await res.json();

    closers.forEach(closer => {

      const dot = document.querySelector(
        `[data-online-dot="${closer.id}"]`
      );

      const text = document.querySelector(
        `[data-online-text="${closer.id}"]`
      );

      if (dot && text) {
        dot.style.background = closer.online ? "#22c55e" : "#6b7280";
        text.textContent = closer.online ? "Online" : "Offline";
      }

    });

  } catch (err) {
    console.error("Error refrescando estado online");
  }

}

// Iniciar intervalo SOLO UNA VEZ
if (!window.onlineInterval) {
  window.onlineInterval = setInterval(refreshOnlineStatus, 5000);
}
</script>


</body>
</html>