<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Administrador</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="style.css">

  <style>
    body {
  margin: 0;
  font-family: Arial, sans-serif;
  overflow-x: hidden;
}

    /* ===== HEADER ===== */
    .topbar {
      height: 60px;
      background: #020617;
      display: flex;
      align-items: center;
      padding: 0 20px;
      border-bottom: 1px solid #1e293b;
    }

    .menu-btn {
      font-size: 22px;
      cursor: pointer;
      background: none;
      border: none;
      color: #f8fafc;
    }

    .title {
      margin-left: 15px;
      font-weight: 600;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      position: fixed;
      top: 0;
      left: -260px;
      width: 260px;
      height: 100%;
      background: #020617;
      border-right: 1px solid #1e293b;
      transition: left 0.3s ease;
      padding-top: 60px;
      z-index: 1000;
    }

    .sidebar.active {
      left: 0;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar li {
      padding: 15px 20px;
      cursor: pointer;
      border-bottom: 1px solid #1e293b;
      transition: background 0.2s;
    }

    .sidebar li:hover {
      background: #1e293b;
    }

    .sidebar li span {
      margin-right: 10px;
    }

    /* ===== CONTENT ===== */
    .content {
      padding: 30px;
      transition: margin-left 0.3s ease;
    }

    .content.shift {
      margin-left: 260px;
    }
  </style>
</head>

<body>

  <div class="topbar">
    <button class="menu-btn" id="menuBtn">‚ò∞</button>
    <div class="title">Panel Administrador</div>
  </div>

  <div class="sidebar" id="sidebar">
    <ul>
      <li data-section="dashboard"><span>üìä</span>Dashboard</li>
      <li data-section="alta"><span>‚ûï</span>Alta de closers</li>
      <li data-section="baja"><span>‚ûñ</span>Baja de closers</li>
      <li data-section="closers"><span>üë§</span>Closers</li>
      <li data-section="ventas"><span>üí∞</span>Ventas</li>
      <li data-section="pagos"><span>üßæ</span>Pago mensual closers</li>
      <li data-section="historico"><span>üìÅ</span>Historico total</li>
      <li data-section="idioma"><span>üåç</span>Idioma</li>
      <li id="logoutBtn"><span>üö™</span>Logout</li>
    </ul>
  </div>

  <div class="content" id="contentArea">

  <!-- CONTENEDOR DIN√ÅMICO -->
  <div id="adminSection"></div>

</div>

<script src="auth.js"></script>

<script>
  const menuBtn = document.getElementById("menuBtn");
  const sidebar = document.getElementById("sidebar");
  const content = document.getElementById("contentArea");
  
  const adminSection = document.getElementById("adminSection");

async function loadSection(section) {

  if (section === "dashboard") {

    const res = await fetch("dashboard.html");
    const html = await res.text();
    adminSection.innerHTML = html;

    // Eliminar app.js anterior si existe
    const oldScript = document.querySelector("script[data-appjs]");
    if (oldScript) oldScript.remove();

    // Crear script nuevo
    const script = document.createElement("script");
    script.src = "app.js";
    script.setAttribute("data-appjs", "true");

    script.onload = function () {
      if (typeof initPricingApp === "function") {
        initPricingApp();
      }
    };

    document.body.appendChild(script);

  } else if (section === "alta") {

  adminSection.innerHTML = `
    <div class="alta-container">

      <button id="btnNuevoCloser" class="btn-nuevo-closer">
        ‚ûï Dar de alta nuevo closer
      </button>
      
      <button id="btnCrearDemoCloser" class="btn-nuevo-closer" style="margin-top:12px; background:#111;">
  üß™ Crear usuario demo
</button>


<div id="demoCloserPanel" style="display:none;margin-top:25px;">
  <div class="card-credenciales">
    <h3>Simulaci√≥n de trabajo del closer</h3>
    <ol style="margin-top:10px;line-height:1.6;">
      <li>1Ô∏è‚É£ Inicia sesi√≥n con su usuario.</li>
      <li>2Ô∏è‚É£ Accede al motor de pricing.</li>
      <li>3Ô∏è‚É£ Calcula precio al restaurante.</li>
      <li>4Ô∏è‚É£ Genera enlace de pago.</li>
      <li>5Ô∏è‚É£ Cuando el cliente paga, la venta se registra autom√°ticamente.</li>
      <li>6Ô∏è‚É£ La comisi√≥n se acumula para el cierre mensual.</li>
    </ol>
    <p class="aviso">
      ‚ö† Esta es una simulaci√≥n visual. No crea datos reales.
    </p>
  </div>
</div>

      <div id="formAltaCloser" class="form-alta-closer" style="display:none;">
        
        <label>Nombre completo
          <input type="text" id="nuevoNombre" placeholder="Ej. Ismael Guerra">
        </label>

        <label>Municipio
          <input type="text" id="nuevoMunicipio" placeholder="Ej. Madrid">
        </label>

        <label>Tel√©fono
          <input type="text" id="nuevoTelefono" placeholder="Ej. +34 600 000 000">
        </label>

        <button id="btnCrearCloser" class="btn-crear-closer">
          Crear closer
        </button>

        <div id="resultadoAlta" class="resultado-alta" style="display:none;"></div>

      </div>

    </div>
  `;

  setTimeout(initAltaCloser, 0);

} else {
  adminSection.innerHTML = `<h2>${section}</h2><p>Secci√≥n en construcci√≥n.</p>`;
}
}

  function toggleMenu() {
    sidebar.classList.toggle("active");
    content.classList.toggle("shift");
  }

  function closeMenu() {
    sidebar.classList.remove("active");
    content.classList.remove("shift");
  }

  // Bot√≥n hamburguesa abre y cierra
  menuBtn.onclick = (e) => {
    e.stopPropagation();
    toggleMenu();
  };

  // Cerrar si haces click fuera del men√∫
  document.addEventListener("click", (e) => {
    if (
      sidebar.classList.contains("active") &&
      !sidebar.contains(e.target) &&
      e.target !== menuBtn
    ) {
      closeMenu();
    }
  });

  // Cerrar al hacer click en una opci√≥n
  document.querySelectorAll(".sidebar li").forEach(item => {
  item.addEventListener("click", () => {

    if (item.id === "logoutBtn") return;

    const section = item.dataset.section;
    if (section) {
      loadSection(section);
    }

    closeMenu();
  });
});

  // Logout
  document.getElementById("logoutBtn").onclick = () => {
    localStorage.clear();
    window.location.href = "login.html";
  };
  
  // Cargar Dashboard por defecto al entrar
loadSection("dashboard");

function initAltaCloser() {

  const btnNuevo = document.getElementById("btnNuevoCloser");
  const form = document.getElementById("formAltaCloser");
  const btnCrear = document.getElementById("btnCrearCloser");
  const resultado = document.getElementById("resultadoAlta");

  const btnCrearDemo = document.getElementById("btnCrearDemoCloser");

  // Mostrar formulario alta real
  btnNuevo.onclick = () => {
    form.style.display = "block";
  };

  // Crear closer REAL
  btnCrear.onclick = async () => {

    const full_name = document.getElementById("nuevoNombre").value.trim();
    const city = document.getElementById("nuevoMunicipio").value.trim();
    const phone = document.getElementById("nuevoTelefono").value.trim();

    if (!full_name || !city) {
      resultado.style.display = "block";
      resultado.innerHTML = `<p style="color:red;">Nombre y municipio son obligatorios</p>`;
      return;
    }

    btnCrear.disabled = true;
    btnCrear.textContent = "Creando...";

    try {

      const res = await fetch(
        "https://stripe-backend-h1z1.vercel.app/api/create-closer",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ full_name, city, phone })
        }
      );

      const data = await res.json();

      if (!res.ok) {
        resultado.style.display = "block";
        resultado.innerHTML = `<p style="color:red;">${data.error}</p>`;
        btnCrear.disabled = false;
        btnCrear.textContent = "Crear closer";
        return;
      }

      resultado.style.display = "block";
      resultado.innerHTML = `
        <div class="card-credenciales">
          <h3>Closer creado correctamente</h3>
          <p><strong>Usuario:</strong> ${data.username}</p>
          <p><strong>Contrase√±a:</strong> ${data.password}</p>
          <p class="aviso">‚ö† Copia estas credenciales ahora. No volver√°n a mostrarse.</p>
        </div>
      `;

      setTimeout(() => {
        resultado.style.display = "none";
      }, 3600000);

    } catch {
      resultado.style.display = "block";
      resultado.innerHTML = `<p style="color:red;">Error servidor</p>`;
    }

    btnCrear.disabled = false;
    btnCrear.textContent = "Crear closer";
  };

  // Crear usuario DEMO
btnCrearDemo.onclick = async () => {

  btnCrearDemo.disabled = true;
  btnCrearDemo.textContent = "Creando demo...";

  try {

    const res = await fetch(
      "https://stripe-backend-h1z1.vercel.app/api/create-demo-closer",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
      }
    );

    const data = await res.json();

    console.log("RESPUESTA DEMO:", data);

    if (!res.ok) {
      resultado.style.display = "block";
      resultado.innerHTML = `<p style="color:red;">${data.error || "Error creando demo"}</p>`;
      return;
    }

    if (!data.username || !data.password) {
      resultado.style.display = "block";
      resultado.innerHTML = `<p style="color:red;">Respuesta inv√°lida del servidor</p>`;
      return;
    }

    resultado.style.display = "block";
    resultado.innerHTML = `
      <div class="card-credenciales">
        <h3>Usuario demo creado</h3>
        <p><strong>Usuario:</strong> ${data.username}</p>
        <p><strong>Contrase√±a:</strong> ${data.password}</p>
        <p class="aviso">‚ö† Funciona hasta que lo elimines manualmente.</p>
      </div>
    `;

  } catch (err) {
    console.error("ERROR DEMO:", err);
    resultado.style.display = "block";
    resultado.innerHTML = `<p style="color:red;">Error creando demo</p>`;
  }

  btnCrearDemo.disabled = false;
  btnCrearDemo.textContent = "üß™ Crear usuario demo";
};


}
</script>


</body>
</html>